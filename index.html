<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Noosphere Archive: Magos C-402 Epsilon Varun</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap');

  :root{
    --bg:#0b0d0f;
    --panel:#12161b;
    --panel2:#0f141a;
    --text:#c7d0d9;
    --muted:#7a8694;
    --red:#1f8f3a;
    --blue:#7fb3ff;
    --border:#222a33;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 10px;
    --royal: "Cinzel", "Trajan Pro", "Garamond", "Times New Roman", serif;
  }

  *{ box-sizing:border-box; }
  html, body{ height:100%; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: Consolas, monospace;
    overflow-x:hidden;
  }

  /* Animated background canvas (behind everything) */
  #noosphere{
    position:fixed;
    inset:0;
    width:100vw;
    height:100vh;
    z-index:0;
    opacity:0.32;
    pointer-events:none;
  }

  /* Vignette overlay */
  .vignette{
    position:fixed;
    inset:0;
    z-index:1;
    pointer-events:none;
    background:
      radial-gradient(ellipse at center, rgba(0,0,0,0) 35%, rgba(0,0,0,.55) 100%),
      radial-gradient(ellipse at 20% 10%, rgba(159,31,31,.10), rgba(0,0,0,0) 55%),
      radial-gradient(ellipse at 80% 90%, rgba(127,179,255,.08), rgba(0,0,0,0) 55%);
    mix-blend-mode: normal;
  }

  /* App shell */
  .app{
    position:relative;
    z-index:2; /* above background */
    min-height:100%;
    display:flex;
    flex-direction:column;
  }

  /* Top bar */
  .topbar{
    position:sticky;
    top:0;
    z-index:10;
    background: linear-gradient(to bottom, rgba(11,13,15,.92), rgba(11,13,15,.78));
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border);
  }
  .topbar-inner{
    display:flex;
    align-items:center;
    gap:12px;
    padding:14px 16px;
    max-width:1100px;
    margin:0 auto;
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap:2px;
    min-width: 200px;
  }
  .brand .title{
    font-weight:800;
    letter-spacing:1px;
    color:var(--red);
    line-height:1.1;
    font-family: var(--royal);
  }
  .brand .subtitle{
    color:var(--muted);
    font-size:12px;
    line-height:1.1;
  }

  .spacer{ flex:1; }

  .iconbtn{
    border:1px solid var(--border);
    background:rgba(18,22,27,.65);
    color:var(--text);
    border-radius:10px;
    padding:10px 12px;
    cursor:pointer;
    box-shadow: var(--shadow);
  }
  .iconbtn:hover{ border-color:#33404e; }

  .admin-pencil{
    position:fixed;
    top:10px;
    left:10px;
    z-index:30;
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid #2b3642;
    background: rgba(18,22,27,.82);
    color: var(--text);
    font-family: var(--royal);
    font-size: 12px;
    letter-spacing: .5px;
    cursor:pointer;
    box-shadow: var(--shadow);
  }
  .admin-pencil:hover{
    border-color:#3a4a5a;
  }
  .admin-pencil svg{
    width:14px;
    height:14px;
    fill: currentColor;
  }

  .admin-modal{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.65);
    z-index:40;
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
  }
  .admin-modal.open{ display:flex; }
  .admin-panel{
    width:min(520px, 92vw);
    max-height: 85vh;
    overflow: auto;
    background: rgba(18,22,27,.96);
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:18px;
  }
  .admin-panel h3{
    margin:0 0 12px 0;
    font-size:14px;
    letter-spacing:.8px;
    color: var(--text);
    font-family: var(--royal);
  }
  .admin-panel label{
    display:block;
    font-size:12px;
    color: var(--muted);
    margin:8px 0 4px 0;
  }
  .admin-panel input,
  .admin-panel textarea{
    width:100%;
    border-radius:8px;
    border:1px solid #2b3642;
    background: rgba(12,16,20,.9);
    color: var(--text);
    padding:10px;
    font-family: var(--royal);
    font-size:12px;
  }
  .admin-panel textarea{
    min-height:120px;
    resize:vertical;
  }
  .admin-actions{
    display:flex;
    gap:10px;
    margin-top:12px;
    justify-content:flex-end;
  }
  .admin-actions button{
    border:1px solid #2b3642;
    background: rgba(18,22,27,.9);
    color: var(--text);
    border-radius:8px;
    padding:8px 12px;
    font-family: var(--royal);
    font-size:12px;
    cursor:pointer;
  }
  .admin-actions button.primary{
    border-color:#2f8b48;
    color:#bfe3c7;
  }
  .admin-actions button:hover{ border-color:#3a4a5a; }
  .admin-divider{
    height:1px;
    background:#1c2430;
    margin:14px 0;
  }
  .reorder-note{
    font-size:11px;
    color: var(--muted);
    margin:0 0 8px 0;
  }
  .reorder-list{
    display:flex;
    flex-direction:column;
    gap:8px;
    max-height: 220px;
    overflow:auto;
    padding:4px 2px;
  }
  .reorder-item{
    display:flex;
    align-items:center;
    gap:10px;
    border:1px solid #24303b;
    border-radius:10px;
    padding:8px 10px;
    background: rgba(12,16,20,.9);
    cursor:grab;
    user-select:none;
  }
  .reorder-item.dragging{
    opacity:.4;
  }
  .reorder-item.drop-target{
    border-color:#3a4a5a;
    box-shadow: 0 0 0 1px rgba(127,179,255,.22);
  }
  .reorder-handle{
    font-size:12px;
    color: var(--muted);
    letter-spacing:1px;
  }
  .reorder-text{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .reorder-text .tag{
    font-size:11px;
    color: var(--blue);
    font-weight:700;
  }
  .reorder-text .label{
    font-size:12px;
    color: var(--text);
  }

  .search{
    display:flex;
    align-items:center;
    gap:10px;
    min-width: 260px;
    max-width: 420px;
    width: 42vw;
    background: rgba(18,22,27,.65);
    border:1px solid var(--border);
    border-radius:999px;
    padding:10px 14px;
    box-shadow: var(--shadow);
  }
  .search .hint{
    color:var(--muted);
    font-size:12px;
    user-select:none;
  }
  .search input{
    border:none;
    outline:none;
    background:transparent;
    color:var(--text);
    width:100%;
    font-family: inherit;
    font-size:13px;
  }
  .search .clear{
    border:none;
    background:transparent;
    color:var(--muted);
    cursor:pointer;
    font-size:14px;
    padding:0 6px;
  }
  .search .clear:hover{ color:var(--text); }

  /* Layout */
  .layout{
    display:flex;
    flex:1;
    max-width:1100px;
    width:100%;
    margin:0 auto;
    padding:18px 16px 40px;
    gap:16px;
  }

  /* Sidebar */
  .sidebar{
    width: 260px;
    flex: 0 0 260px;
    background: rgba(18,22,27,.78);
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 14px;
    position:sticky;
    top: 72px;
    height: fit-content;
  }
  .sidebar h3{
    margin:0 0 10px 0;
    color: var(--text);
    font-size: 13px;
    letter-spacing:.6px;
    border-bottom:1px solid #2a3441;
    padding-bottom:8px;
    font-family: var(--royal);
  }
  .chapters{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .chapters a{
    text-decoration:none;
    color: var(--text);
    padding:10px 10px;
    border-radius:10px;
    border:1px solid transparent;
    background: rgba(15,20,26,.6);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .chapters a:hover{
    border-color:#33404e;
  }
  .chapters .tag{
    color: var(--blue);
    font-weight:700;
    font-size:12px;
  }
  .chapters .label{
    color: var(--muted);
    font-size:12px;
  }

  .sidebar .meta{
    margin-top:14px;
    font-size:12px;
    color: var(--muted);
    border-top:1px solid #2a3441;
    padding-top:12px;
    line-height:1.4;
  }

  /* Main content */
  main{
    flex:1;
    min-width:0;
  }

  h1, h2, h3{
    color: var(--red);
    border-bottom: 1px solid #333;
    padding-bottom: 5px;
    margin: 0 0 12px 0;
    font-family: var(--royal);
  }
  h1{
    font-size: 22px;
    letter-spacing: 1px;
  }
  h2{
    font-size: 16px;
    margin-top: 14px;
  }

  .archive-box{
    background: rgba(18,22,27,.82);
    padding: 20px;
    margin-bottom: 16px;
    border-left: 4px solid var(--red);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .year{
    color: var(--blue);
    font-weight: bold;
    margin:0 0 8px 0;
  }
  .classified{
    color: #888;
    font-style: italic;
  }

  footer{
    margin-top: 22px;
    font-size: 12px;
    color: #555;
    border-top: 1px solid #222;
    padding-top: 15px;
  }

  /* Search filtering */
  .hidden{ display:none !important; }
  mark{
    background: rgba(127,179,255,.18);
    color: var(--text);
    padding:0 2px;
    border-radius:4px;
  }

  /* Mobile: sidebar becomes overlay drawer */
  .backdrop{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.55);
    z-index: 20;
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease;
  }
  .drawer{
    position:fixed;
    top:0;
    left:0;
    height:100%;
    width: 290px;
    background: rgba(18,22,27,.96);
    border-right:1px solid var(--border);
    z-index: 21;
    transform: translateX(-102%);
    transition: transform .18s ease;
    padding: 14px;
    overflow:auto;
  }
  .drawer .drawer-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom: 10px;
  }
  .drawer .drawer-top .dtitle{
    color: var(--text);
    font-size: 13px;
    letter-spacing:.6px;
    font-family: var(--royal);
  }

  body.drawer-open .backdrop{
    opacity:1;
    pointer-events:auto;
  }
  body.drawer-open .drawer{
    transform: translateX(0);
  }

  @media (max-width: 980px){
    .sidebar{ display:none; }
    .layout{ padding-top: 14px; }
    .search{ width: 52vw; min-width: 180px; }
  }
  @media (max-width: 560px){
    .brand{ min-width: 0; }
    .brand .subtitle{ display:none; }
    .search{ width: 56vw; }
    body{ font-size: 14px; }
  }
  /* Revision Log */
  .rev-list{
    margin: 10px 0 0 0;
    padding-left: 16px;
    color: var(--text);
  }
  .rev-list li{
    margin: 8px 0;
    line-height: 1.4;
  }
  .rev-date{
    color: var(--blue);
    font-weight: 700;
    margin-right: 8px;
    white-space: nowrap;
  }
  .rev-note{
    color: var(--text);
  }
  .rev-hint{
    margin-top: 12px;
    font-size: 12px;
    color: var(--muted);
  }

  /* Admin: small section headers */
  .admin-panel .section-title{
    margin-top: 14px;
    font-size: 12px;
    color: var(--muted);
    letter-spacing: .8px;
    font-family: var(--royal);
    text-transform: uppercase;
  }
  .admin-actions .danger{
    border-color:#5a2f2f;
    color:#ffcccc;
  }

</style>
</head>

<body>
<canvas id="noosphere" aria-hidden="true"></canvas>
<div class="vignette" aria-hidden="true"></div>

<button class="admin-pencil" id="adminPencil" aria-label="Admin: Add chapter" title="Admin: Add chapter">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l9.06-9.06.92.92-9.06 9.06zM20.71 6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 0l-1.12 1.12 3.75 3.75 1.12-1.12z"/>
  </svg>
  ADMIN
</button>

<div class="admin-modal" id="adminModal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="admin-panel">
    <h3 id="adminTitle">ADD NEW CHAPTER</h3>
    <label for="chapterTag">Chapter tag</label>
    <input id="chapterTag" type="text" placeholder="e.g., -1 or NOW" />
    <label for="chapterLabel">Chapter title</label>
    <input id="chapterLabel" type="text" placeholder="Short label for the list" />
    <label for="chapterBody">Chapter entry</label>
    <textarea id="chapterBody" placeholder="Write the entry text here..."></textarea>
    <div class="admin-actions">
      <button type="button" id="adminCancel">Cancel</button>
      <button type="button" class="primary" id="adminSave">Save chapter</button>
    </div>
    <div class="admin-divider"></div>
    <h3>REORDER CHAPTERS</h3>
    <p class="reorder-note">Drag a chapter to change its order in the list.</p>
    <p class="reorder-note">Tip: Scroll INSIDE this panel to reach “ADD REVISION” and “Export JSON”.</p>
    <div class="reorder-list" id="reorderList" aria-live="polite">
      <!-- injected by JS -->
    </div>
  </div>
</div>

<div class="backdrop" id="backdrop" aria-hidden="true"></div>

<!-- Mobile drawer -->
<aside class="drawer" id="drawer" aria-label="Chapters">
  <div class="drawer-top">
    <div class="dtitle">CHAPTERS</div>
    <button class="iconbtn" id="closeDrawer" aria-label="Close menu">✕</button>
  </div>
  <div class="chapters" id="chaptersDrawer">
    <!-- injected by JS -->
  </div>
  <div class="meta">
    Access: Magenta-7+<br/>
    Archive Node: C-402-E / VARUN<br/>
    Integrity: Verified
  </div>
</aside>

<div class="app">

  <header class="topbar">
    <div class="topbar-inner">
      <button class="iconbtn" id="openDrawer" aria-label="Open menu">☰</button>

      <div class="brand">
        <div class="title">NOOSPHERE ARCHIVE</div>
        <div class="subtitle">Magos C-402 Epsilon Varun</div>
      </div>

      <div class="spacer"></div>

      <div class="search" role="search" aria-label="Search archive">
        <span class="hint">⌕</span>
        <input id="searchInput" type="search" placeholder="Search keywords (e.g., STC, injector, Last Rose)..." />
        <button class="clear" id="clearBtn" title="Clear">×</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- Desktop sidebar -->
    <aside class="sidebar" aria-label="Chapters">
      <h3>CHAPTER LIST</h3>
      <div class="chapters" id="chaptersSidebar">
        <!-- injected by JS -->
      </div>
      <div class="meta">
        Access: Magenta-7+<br/>
        Archive Node: C-402-E / VARUN<br/>
        Integrity: Verified
      </div>
    </aside>

    <main>
      <!-- Your original content preserved, with IDs added for chapter navigation -->
      <h1>NOOSPHERE ARCHIVE</h1>
      <h2>Magos C-402 Epsilon Varun</h2>

      <div class="archive-box" data-entry="profile" id="profile">
        <p><strong>Designation:</strong> C-402 Epsilon Varun</p>
        <p><strong>Rank:</strong> Magos Dominus (Exploratory Division)</p>
        <p><strong>Affiliation:</strong> Adeptus Mechanicus</p>
        <p><strong>Status:</strong> Active – Restricted Clearance Required</p>
        <p><strong>Archive Span:</strong> 50 Years Prior to Current Imperial Date</p>
      </div>

      <h2>Chronological Expedition Record</h2>

      <div class="archive-box" data-entry="year" id="y-50">
        <p class="year">-50 Years</p>
        <p>Initial recorded field deployment under Forge oversight. Assigned to deep-void exploratory fleet operations. Specialization in archaeological recovery and adaptive battlefield augmentation.</p>
      </div>

      <div class="archive-box" data-entry="year" id="y-44">
        <p class="year">-44 Years</p>
        <p>Recovered fragmented Standard Template Construct (STC) subroutine from derelict manufactorum structure. Data integrity at 23%. Deemed tactically viable.</p>
      </div>

      <div class="archive-box" data-entry="year" id="y-38">
        <p class="year">-38 Years</p>
        <p>Augmentation Phase Delta-III completed. Integration of articulated mechadendrite cluster with injector, plasma micro-torch, and data-spike termination systems.</p>
      </div>

      <div class="archive-box" data-entry="year" id="y-29">
        <p class="year">-29 Years</p>
        <p>Participated in classified void engagement. Deployment of mobile battlefield autopsy protocols. Casualty reclamation efficiency exceeded projected thresholds.</p>
      </div>

      <div class="archive-box" data-entry="year" id="y-21">
        <p class="year">-21 Years</p>
        <p>Reassignment to independent exploratory mandate. Increased operational autonomy granted.</p>
      </div>

      <div class="archive-box" data-entry="year" id="y-14">
        <p class="year">-14 Years</p>
        <p>Boarded void vessel <em>The Last Rose</em> under mutually beneficial technological accord. Integration into ship-based manufactorum oversight and expeditionary support.</p>
      </div>

      <div class="archive-box" data-entry="year" id="y-7">
        <p class="year">-7 Years</p>
        <p>Servo-skull reconnaissance unit upgraded. Dual ocular configuration implemented: one skeletal cavity retained for symbolic function; one active auspex scanner lens installed.</p>
      </div>

      <div class="archive-box" data-entry="year" id="y-current">
        <p class="year">Current Era</p>
        <p>Magos Varun continues exploratory operations and battlefield technological reclamation aboard The Last Rose. Multiple data clusters remain <span class="classified">CLASSIFIED</span>.</p>
      </div>

      <h2>Revision Log</h2>

      <div class="archive-box" data-entry="revisions" id="revisions">
        <p class="year">ARCHIVE REVISIONS</p>
        <ul class="rev-list" id="revisionList" aria-live="polite"></ul>
        <p class="rev-hint">Tip: Use ADMIN → Add Revision to record changes like a proper Martian scribe.</p>
      </div>

      <footer>
        Data Integrity Verified.<br/>
        Access Level: Magenta-7 or Higher.<br/>
        Unauthorized replication punishable under Martian Code.
      </footer>
    </main>
  </div>
</div>

<script>

/* =========================================================
   Varun Archive — upgrades:
   1) Revision Log UI
   2) Persistent storage (localStorage)
   3) Export to JSON
   ========================================================= */

const STORAGE_KEY = "varun_archive_data_v1";

/* ---- Defaults (these are the 'factory settings') ---- */
const DEFAULT_CHAPTERS = [
  { id: "profile", tag: "CORE", label: "Profile Node", type: "builtin" },
  { id: "revisions", tag: "REV", label: "Revision Log", type: "builtin" },
  { id: "y-50", tag: "-50", label: "Initial Deployment", type: "builtin" },
  { id: "y-44", tag: "-44", label: "STC Fragment", type: "builtin" },
  { id: "y-38", tag: "-38", label: "Augmentation Delta-III", type: "builtin" },
  { id: "y-29", tag: "-29", label: "Classified Engagement", type: "builtin" },
  { id: "y-21", tag: "-21", label: "Autonomy Grant", type: "builtin" },
  { id: "y-14", tag: "-14", label: "Boards The Last Rose", type: "builtin" },
  { id: "y-7",  tag: "-7",  label: "Servo-skull Upgrade", type: "builtin" },
  { id: "y-current", tag: "NOW", label: "Current Era", type: "builtin" }
];

const DEFAULT_REVISIONS = [
  { date: "GENESIS", note: "Archive initialized. Machine-spirits appeased." }
];

/* ---- Load / Save ---- */
function safeParse(jsonText){
  try { return JSON.parse(jsonText); } catch { return null; }
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  const parsed = raw ? safeParse(raw) : null;

  // If nothing saved, return defaults
  if(!parsed || typeof parsed !== "object"){
    return {
      version: 1,
      chapters: structuredClone(DEFAULT_CHAPTERS),
      revisions: structuredClone(DEFAULT_REVISIONS)
    };
  }

  // Minimal validation
  const chapters = Array.isArray(parsed.chapters) ? parsed.chapters : structuredClone(DEFAULT_CHAPTERS);
  const revisions = Array.isArray(parsed.revisions) ? parsed.revisions : structuredClone(DEFAULT_REVISIONS);

  return { version: 1, chapters, revisions };
}

function saveState(){
  const payload = {
    version: 1,
    savedAt: new Date().toISOString(),
    chapters,
    revisions
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}

/* ---- Live state (in-memory) ---- */
let { chapters, revisions } = loadState();

/* =========================================================
   UI: Chapters (desktop + mobile)
   ========================================================= */
function renderChapters(container){
  if(!container) return;
  container.innerHTML = chapters.map(c => `
    <a href="#${c.id}" data-target="${c.id}">
      <span class="tag">${c.tag}</span>
      <span class="label">${c.label}</span>
    </a>
  `).join("");
}

const chaptersSidebar = document.getElementById("chaptersSidebar");
const chaptersDrawer = document.getElementById("chaptersDrawer");
const reorderList = document.getElementById("reorderList");

function renderReorderList(){
  if(!reorderList) return;
  reorderList.innerHTML = chapters.map(c => `
    <div class="reorder-item" draggable="true" data-id="${c.id}">
      <span class="reorder-handle">⠿</span>
      <span class="reorder-text">
        <span class="tag">${c.tag}</span>
        <span class="label">${c.label}</span>
      </span>
    </div>
  `).join("");
}

function syncChaptersUI(){
  renderChapters(chaptersSidebar);
  renderChapters(chaptersDrawer);
  renderReorderList();
}
syncChaptersUI();

function smoothScrollTo(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.scrollIntoView({ behavior: "smooth", block: "start" });
}

document.addEventListener("click", (e) => {
  const a = e.target.closest('a[data-target]');
  if(!a) return;
  e.preventDefault();
  const id = a.getAttribute("data-target");
  smoothScrollTo(id);
  closeDrawer();
});

/* =========================================================
   Drawer open/close (mobile)
   ========================================================= */
const openBtn = document.getElementById("openDrawer");
const closeBtn = document.getElementById("closeDrawer");
const backdrop = document.getElementById("backdrop");

function openDrawer(){ document.body.classList.add("drawer-open"); }
function closeDrawer(){ document.body.classList.remove("drawer-open"); }

if(openBtn) openBtn.addEventListener("click", openDrawer);
if(closeBtn) closeBtn.addEventListener("click", closeDrawer);
if(backdrop) backdrop.addEventListener("click", closeDrawer);

/* =========================================================
   Search filter + highlight (robust)
   ========================================================= */
const input = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");
let boxes = Array.from(document.querySelectorAll(".archive-box"));
const footerEl = document.querySelector("footer");

function stripMarks(node){
  const marks = node.querySelectorAll("mark");
  marks.forEach(m => {
    const text = document.createTextNode(m.textContent);
    m.replaceWith(text);
  });
  // IMPORTANT: merges adjacent text nodes so multi-letter searches work after prior highlight
  node.normalize();
}

function escapeRegExp(s){
  return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function highlightText(node, q){
  if(!q) return;

  const re = new RegExp(escapeRegExp(q), "ig");
  const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null);
  const textNodes = [];
  while(walker.nextNode()) textNodes.push(walker.currentNode);

  for(const t of textNodes){
    const val = t.nodeValue;
    if(!val) continue;
    if(!re.test(val)) continue;
    re.lastIndex = 0;

    const frag = document.createDocumentFragment();
    let last = 0;

    val.replace(re, (match, offset) => {
      frag.appendChild(document.createTextNode(val.slice(last, offset)));
      const mk = document.createElement("mark");
      mk.textContent = match;
      frag.appendChild(mk);
      last = offset + match.length;
      return match;
    });

    frag.appendChild(document.createTextNode(val.slice(last)));
    t.parentNode.replaceChild(frag, t);
  }
}

function applySearch(){
  if(!input) return;
  const q = input.value.trim();

  boxes.forEach(b => stripMarks(b));

  if(!q){
    boxes.forEach(b => b.classList.remove("hidden"));
    return;
  }

  const qLower = q.toLowerCase();

  boxes.forEach(b => {
    const txt = b.innerText.toLowerCase();
    const hit = txt.includes(qLower);
    b.classList.toggle("hidden", !hit);
    if(hit) highlightText(b, q);
  });
}

if(input) input.addEventListener("input", applySearch);
if(clearBtn) clearBtn.addEventListener("click", () => {
  if(!input) return;
  input.value = "";
  applySearch();
  input.focus();
});

/* =========================================================
   Admin modal: add chapter + reorder + revisions + export
   ========================================================= */
const adminPencil = document.getElementById("adminPencil");
const adminModal = document.getElementById("adminModal");
const adminCancel = document.getElementById("adminCancel");
const adminSave = document.getElementById("adminSave");
const chapterTag = document.getElementById("chapterTag");
const chapterLabel = document.getElementById("chapterLabel");
const chapterBody = document.getElementById("chapterBody");

const revDate = document.getElementById("revDate");
const revNote = document.getElementById("revNote");
const revSave = document.getElementById("revSave");
const exportBtn = document.getElementById("exportJson");
const resetBtn = document.getElementById("resetLocal");

function openAdmin(){
  if(!adminModal) return;
  adminModal.classList.add("open");
  renderReorderList();
  chapterTag?.focus();
}
function closeAdmin(){
  if(!adminModal) return;
  adminModal.classList.remove("open");
  if(chapterTag) chapterTag.value = "";
  if(chapterLabel) chapterLabel.value = "";
  if(chapterBody) chapterBody.value = "";
  if(revDate) revDate.value = "";
  if(revNote) revNote.value = "";
}

function slugify(text){
  return text.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
}

function insertCustomBox(ch){
  const box = document.createElement("div");
  box.className = "archive-box";
  box.dataset.entry = "custom";
  box.id = ch.id;
  box.innerHTML = `
    <p class="year">${ch.tag}</p>
    <p><strong>${ch.label}</strong></p>
    <p>${(ch.body || "").replace(/\n/g, "<br/>")}</p>
  `;
  // Insert before footer
  if(footerEl && footerEl.parentNode){
    footerEl.parentNode.insertBefore(box, footerEl);
  } else {
    document.body.appendChild(box);
  }
}

function rebuildCustomBoxesFromState(){
  // remove existing custom boxes
  document.querySelectorAll('.archive-box[data-entry="custom"]').forEach(el => el.remove());

  // re-insert in the order they appear in chapters
  for(const ch of chapters){
    if(ch.type === "custom"){
      insertCustomBox(ch);
    }
  }

  boxes = Array.from(document.querySelectorAll(".archive-box"));
}

function addChapter(){
  const tag = (chapterTag?.value || "").trim() || "NEW";
  const label = (chapterLabel?.value || "").trim();
  const body = (chapterBody?.value || "").trim();

  if(!label || !body){
    chapterLabel?.focus();
    return;
  }

  const idBase = slugify(label) || "chapter";
  const id = `${idBase}-${Date.now().toString(36)}`;

  const ch = { id, tag, label, type: "custom", body };
  chapters.push(ch);

  saveState();
  syncChaptersUI();
  rebuildCustomBoxesFromState();
  applySearch();
  closeAdmin();
  smoothScrollTo(id);
}

if(adminPencil) adminPencil.addEventListener("click", openAdmin);
if(adminCancel) adminCancel.addEventListener("click", closeAdmin);
if(adminModal) adminModal.addEventListener("click", (e) => {
  if(e.target === adminModal) closeAdmin();
});
if(adminSave) adminSave.addEventListener("click", addChapter);

window.addEventListener("keydown", (e) => {
  if(e.key === "Escape"){
    closeDrawer();
    closeAdmin();
  }
});

/* ---- Reorder drag/drop ---- */
let draggingId = null;
let dropTargetId = null;

function moveChapterBefore(movedId, targetId){
  if(!movedId || !targetId || movedId === targetId) return;
  const fromIndex = chapters.findIndex(c => c.id === movedId);
  const toIndex = chapters.findIndex(c => c.id === targetId);
  if(fromIndex < 0 || toIndex < 0) return;
  const [item] = chapters.splice(fromIndex, 1);
  const insertIndex = fromIndex < toIndex ? toIndex - 1 : toIndex;
  chapters.splice(insertIndex, 0, item);
}

function moveChapterToEnd(movedId){
  const fromIndex = chapters.findIndex(c => c.id === movedId);
  if(fromIndex < 0) return;
  const [item] = chapters.splice(fromIndex, 1);
  chapters.push(item);
}

function clearDropTargets(){
  const targets = reorderList ? reorderList.querySelectorAll(".drop-target") : [];
  targets.forEach(t => t.classList.remove("drop-target"));
}

if(reorderList){
  reorderList.addEventListener("dragstart", (e) => {
    const item = e.target.closest(".reorder-item");
    if(!item) return;
    draggingId = item.dataset.id;
    item.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  });

  reorderList.addEventListener("dragend", () => {
    draggingId = null;
    dropTargetId = null;
    reorderList.querySelectorAll(".reorder-item").forEach(i => i.classList.remove("dragging"));
    clearDropTargets();
  });

  reorderList.addEventListener("dragover", (e) => {
    e.preventDefault();
    const item = e.target.closest(".reorder-item");
    clearDropTargets();
    if(item && item.dataset.id !== draggingId){
      item.classList.add("drop-target");
      dropTargetId = item.dataset.id;
    } else {
      dropTargetId = null;
    }
  });

  reorderList.addEventListener("drop", (e) => {
    e.preventDefault();
    if(!draggingId) return;
    if(dropTargetId){
      moveChapterBefore(draggingId, dropTargetId);
    } else {
      moveChapterToEnd(draggingId);
    }
    saveState();
    syncChaptersUI();
    rebuildCustomBoxesFromState();
    clearDropTargets();
  });
}

/* =========================================================
   Revision Log UI
   ========================================================= */
const revisionList = document.getElementById("revisionList");

function renderRevisions(){
  if(!revisionList) return;
  if(!Array.isArray(revisions) || revisions.length === 0){
    revisionList.innerHTML = "<li><span class='rev-date'>NULL</span><span class='rev-note'>No revisions recorded.</span></li>";
    return;
  }
  revisionList.innerHTML = revisions.map(r => `
    <li>
      <span class="rev-date">${r.date || "REV"}</span>
      <span class="rev-note">${r.note || ""}</span>
    </li>
  `).join("");
}
renderRevisions();

function addRevision(){
  const date = (revDate?.value || "").trim() || new Date().toISOString().slice(0,10);
  const note = (revNote?.value || "").trim();
  if(!note){
    revNote?.focus();
    return;
  }
  revisions.unshift({ date, note });
  saveState();
  renderRevisions();
  closeAdmin();
  smoothScrollTo("revisions");
}

if(revSave) revSave.addEventListener("click", addRevision);

/* =========================================================
   Export JSON
   ========================================================= */
function exportJSON(){
  const payload = {
    version: 1,
    exportedAt: new Date().toISOString(),
    chapters,
    revisions
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "varun-archive-backup.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

if(exportBtn) exportBtn.addEventListener("click", exportJSON);

/* =========================================================
   Reset local data (safety button)
   ========================================================= */
function resetLocal(){
  const ok = confirm("Reset local saved data? This clears saved chapters + revisions on THIS browser only.");
  if(!ok) return;
  localStorage.removeItem(STORAGE_KEY);

  // restore defaults in memory
  chapters = structuredClone(DEFAULT_CHAPTERS);
  revisions = structuredClone(DEFAULT_REVISIONS);

  syncChaptersUI();
  rebuildCustomBoxesFromState();
  renderRevisions();
  applySearch();
  closeAdmin();
}

if(resetBtn) resetBtn.addEventListener("click", resetLocal);

/* =========================================================
   On load: rebuild any saved custom chapters
   ========================================================= */
rebuildCustomBoxesFromState();
renderRevisions();

/* ===== Noosphere background (telemetry streams, NOT matrix rain) ===== */
(() => {
  const canvas = document.getElementById("noosphere");
  if(!canvas) return;
  const ctx = canvas.getContext("2d", { alpha: true });

  const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  const DPR = () => Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  const state = {
    w: 0, h: 0,
    streaks: [],
    pulses: [],
    glyphs: []
  };

  const rand = (min, max) => Math.random() * (max - min) + min;

  function resize(){
    const dpr = DPR();
    state.w = canvas.width = Math.floor(window.innerWidth * dpr);
    state.h = canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);

    if(prefersReduced){
      seed(90);
      drawStatic();
    } else {
      seed(130);
    }
  }

  function seed(count){
    state.streaks = [];
    for(let i=0;i<count;i++){
      const diag = Math.random() < 0.42;
      state.streaks.push({
        x: rand(-80, window.innerWidth + 80),
        y: rand(0, window.innerHeight),
        len: rand(10, 44),
        speed: rand(0.10, 0.45),
        angle: diag ? rand(-0.28, -0.06) : rand(-0.06, 0.06), // mostly horizontal, some diagonal
        alpha: rand(0.05, 0.22),
        red: Math.random() < 0.045
      });
    }
    state.pulses = [];
    state.glyphs = [];
  }

  function spawnPulse(){
    if(state.pulses.length > 2) return;
    const vertical = Math.random() < 0.25;
    state.pulses.push({
      t: 0,
      vertical,
      pos: vertical ? rand(0.15, 0.85) * window.innerWidth : rand(0.2, 0.8) * window.innerHeight,
      width: rand(140, 320),
      alpha: rand(0.06, 0.14)
    });
  }

  function spawnGlyphCluster(){
    if(state.glyphs.length > 6) return;
    const chars = "01ABCDEF";
    const count = Math.floor(rand(3, 10));
    let text = "";
    for(let i=0;i<count;i++) text += chars[Math.floor(rand(0, chars.length))];
    state.glyphs.push({
      x: rand(18, window.innerWidth - 60),
      y: rand(26, window.innerHeight - 18),
      text,
      life: Math.floor(rand(70, 150)),
      alpha: rand(0.06, 0.18),
      red: Math.random() < 0.08
    });
  }

  function clearFrame(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    // faint wash to avoid hard flicker
    ctx.fillStyle = "rgba(10, 14, 18, 0.10)";
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
  }

  function drawStreaks(){
    for(const s of state.streaks){
      ctx.save();
      ctx.translate(s.x, s.y);
      ctx.rotate(s.angle);

      const col = s.red ? "rgba(180,40,40,0.22)" : "rgba(125,190,255,0.24)";
      ctx.strokeStyle = col;
      ctx.globalAlpha = s.alpha;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(s.len,0);
      ctx.stroke();
      ctx.restore();

      // drift mostly right + slight down (telemetry)
      s.x += Math.cos(s.angle) * s.speed * 1.4;
      s.y += Math.sin(s.angle) * s.speed * 0.6 + s.speed * 0.06;

      if(s.x > window.innerWidth + 120 || s.y > window.innerHeight + 80){
        s.x = rand(-140, -20);
        s.y = rand(0, window.innerHeight);
        s.len = rand(10, 44);
        s.speed = rand(0.10, 0.45);
        s.alpha = rand(0.05, 0.22);
        s.red = Math.random() < 0.045;
      }
    }
  }

  function drawPulses(){
    state.pulses = state.pulses.filter(p => p.t < 1);
    for(const p of state.pulses){
      p.t += 0.010;
      ctx.save();
      ctx.globalAlpha = p.alpha * (1 - p.t);
      ctx.strokeStyle = "rgba(125,190,255,0.22)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      if(p.vertical){
        const x = p.pos + Math.sin(p.t * Math.PI) * p.width * 0.08;
        ctx.moveTo(x, 0);
        ctx.lineTo(x, window.innerHeight);
      } else {
        const y = p.pos + Math.cos(p.t * Math.PI) * p.width * 0.07;
        ctx.moveTo(0, y);
        ctx.lineTo(window.innerWidth, y);
      }
      ctx.stroke();
      ctx.restore();
    }
  }

  function drawGlyphs(){
    ctx.save();
    ctx.font = "10px Consolas, monospace";
    state.glyphs = state.glyphs.filter(g => g.life > 0);
    for(const g of state.glyphs){
      const col = g.red ? "rgba(200,60,60,0.28)" : "rgba(145,200,255,0.30)";
      ctx.fillStyle = col;
      ctx.globalAlpha = g.alpha * (g.life / 150);
      ctx.fillText(g.text, g.x, g.y);
      g.life -= 1;
    }
    ctx.restore();
  }

  function drawStatic(){
    clearFrame();
    // draw a fixed pattern snapshot
    drawStreaks();
    for(let i=0;i<4;i++) spawnGlyphCluster();
    drawGlyphs();
    // subtle lines
    ctx.save();
    ctx.globalAlpha = 0.10;
    ctx.strokeStyle = "rgba(125,190,255,0.20)";
    ctx.lineWidth = 1;
    for(let i=0;i<5;i++){
      const y = rand(0, window.innerHeight);
      ctx.beginPath();
      ctx.moveTo(0,y);
      ctx.lineTo(window.innerWidth,y);
      ctx.stroke();
    }
    ctx.restore();
  }

  function animate(){
    if(prefersReduced) return;
    clearFrame();
    if(Math.random() < 0.020) spawnPulse();
    if(Math.random() < 0.045) spawnGlyphCluster();
    drawStreaks();
    drawPulses();
    drawGlyphs();
    requestAnimationFrame(animate);
  }

  window.addEventListener("resize", resize);
  resize();
  if(!prefersReduced) animate();
})();
</script>
</body>
</html>
2
