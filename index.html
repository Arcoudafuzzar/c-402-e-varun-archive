<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Noosphere Archive: Magos C-402 Epsilon Varun</title>
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap');
  :root{
    --bg:#0b0d0f; --panel:#12161b; --panel2:#0f141a;
    --text:#c7d0d9; --muted:#7a8694;
    --accent:#1f8f3a; --blue:#7fb3ff;
    --border:#222a33; --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 10px;
    --royal: "Cinzel","Trajan Pro","Garamond","Times New Roman",serif;
    --danger:#c84a4a; --warning:#d1a93a;
  }
  *{box-sizing:border-box;} html,body{height:100%;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Consolas,monospace;overflow-x:hidden;}
  #noosphere{position:fixed;inset:0;width:100vw;height:100vh;z-index:0;opacity:.32;pointer-events:none;}
  .vignette{position:fixed;inset:0;z-index:1;pointer-events:none;background:
    radial-gradient(ellipse at center, rgba(0,0,0,0) 35%, rgba(0,0,0,.55) 100%),
    radial-gradient(ellipse at 20% 10%, rgba(31,143,58,.10), rgba(0,0,0,0) 55%),
    radial-gradient(ellipse at 80% 90%, rgba(127,179,255,.08), rgba(0,0,0,0) 55%);}
  .app{position:relative;z-index:2;min-height:100%;display:flex;flex-direction:column;}
  .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(to bottom, rgba(11,13,15,.92), rgba(11,13,15,.78));
    backdrop-filter: blur(8px);border-bottom:1px solid var(--border);}
  .topbar-inner{display:flex;align-items:center;gap:12px;padding:14px 16px;max-width:1100px;margin:0 auto;}
  .brand{display:flex;flex-direction:column;gap:2px;min-width:200px;}
  .brand .title{font-weight:800;letter-spacing:1px;color:var(--accent);line-height:1.1;font-family:var(--royal);}
  .brand .subtitle{color:var(--muted);font-size:12px;line-height:1.1;}
  .spacer{flex:1;}
  .iconbtn{border:1px solid var(--border);background:rgba(18,22,27,.65);color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer;box-shadow:var(--shadow);user-select:none;}
  .iconbtn:hover{border-color:#33404e;}
  .search{display:flex;align-items:center;gap:10px;min-width:260px;max-width:420px;width:42vw;background:rgba(18,22,27,.65);
    border:1px solid var(--border);border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);}
  .search .hint{color:var(--muted);font-size:12px;user-select:none;}
  .search input{border:none;outline:none;background:transparent;color:var(--text);width:100%;font-family:inherit;font-size:13px;}
  .search .clear{border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:14px;padding:0 6px;}
  .search .clear:hover{color:var(--text);}
  .layout{display:flex;flex:1;max-width:1100px;width:100%;margin:0 auto;padding:18px 16px 40px;gap:16px;}
  .sidebar{width:260px;flex:0 0 260px;background:rgba(18,22,27,.78);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:14px;position:sticky;top:72px;height:fit-content;}
  .sidebar h3{margin:0 0 10px 0;color:var(--text);font-size:13px;letter-spacing:.6px;border-bottom:1px solid #2a3441;
    padding-bottom:8px;font-family:var(--royal);}
  .chapters{display:flex;flex-direction:column;gap:8px;}
  .chapters a{text-decoration:none;color:var(--text);padding:10px 10px;border-radius:10px;border:1px solid transparent;background:rgba(15,20,26,.6);
    display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .chapters a:hover{border-color:#33404e;}
  .chapters .tag{color:var(--blue);font-weight:700;font-size:12px;white-space:nowrap;}
  .chapters .label{color:var(--muted);font-size:12px;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:140px;}
  .sidebar .meta{margin-top:14px;font-size:12px;color:var(--muted);border-top:1px solid #2a3441;padding-top:12px;line-height:1.4;}
  main{flex:1;min-width:0;}
  h1,h2,h3{color:var(--accent);border-bottom:1px solid #333;padding-bottom:5px;margin:0 0 12px 0;font-family:var(--royal);}
  h1{font-size:22px;letter-spacing:1px;} h2{font-size:16px;margin-top:14px;}
  .archive-box{background:rgba(18,22,27,.82);padding:20px;margin-bottom:16px;border-left:4px solid var(--accent);
    border-radius:var(--radius);box-shadow:var(--shadow);position:relative;}
  .year{color:var(--blue);font-weight:bold;margin:0 0 8px 0;}
  .classified{color:#888;font-style:italic;}
  footer{margin-top:22px;font-size:12px;color:#555;border-top:1px solid #222;padding-top:15px;}
  .hidden{display:none!important;}
  mark{background:rgba(127,179,255,.22);color:var(--text);padding:0 2px;border-radius:4px;}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:20;opacity:0;pointer-events:none;transition:opacity .18s ease;}
  .drawer{position:fixed;top:0;left:0;height:100%;width:290px;background:rgba(18,22,27,.96);border-right:1px solid var(--border);
    z-index:21;transform:translateX(-102%);transition:transform .18s ease;padding:14px;overflow:auto;}
  .drawer .drawer-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .drawer .drawer-top .dtitle{color:var(--text);font-size:13px;letter-spacing:.6px;font-family:var(--royal);}
  body.drawer-open .backdrop{opacity:1;pointer-events:auto;}
  body.drawer-open .drawer{transform:translateX(0);}
  .admin-pill{position:fixed;top:10px;left:10px;z-index:30;display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
    border:1px solid #2b3642;background:rgba(18,22,27,.82);color:var(--text);font-family:var(--royal);font-size:12px;letter-spacing:.5px;
    cursor:pointer;box-shadow:var(--shadow);user-select:none;}
  .admin-pill:hover{border-color:#3a4a5a;}
  .admin-pill svg{width:14px;height:14px;fill:currentColor;}
  .admin-pill .dot{width:7px;height:7px;border-radius:999px;background:rgba(122,134,148,.7);box-shadow:0 0 0 2px rgba(0,0,0,.25);}
  body.admin-on .admin-pill .dot{background:rgba(31,143,58,.95);}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:40;display:none;align-items:center;justify-content:center;padding:18px;}
  .modal.open{display:flex;}
  .panel{width:min(740px,96vw);background:rgba(18,22,27,.96);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;}
  .panel-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:12px;}
  .panel-top h3{margin:0;font-size:14px;letter-spacing:.8px;color:var(--text);font-family:var(--royal);border:none;padding:0;}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;}
  .tabbtn{border:1px solid #2b3642;background:rgba(12,16,20,.85);color:var(--text);border-radius:999px;padding:7px 10px;font-family:var(--royal);
    font-size:12px;cursor:pointer;user-select:none;}
  .tabbtn.active{border-color:rgba(31,143,58,.9);box-shadow:0 0 0 1px rgba(31,143,58,.25);}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  @media (max-width:840px){.grid{grid-template-columns:1fr;}}
  .section{border:1px solid #24303b;border-radius:12px;padding:12px;background:rgba(12,16,20,.75);}
  .section h4{margin:0 0 10px 0;color:var(--text);font-size:12px;letter-spacing:.8px;font-family:var(--royal);}
  .field label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px 0;}
  .field input,.field textarea{width:100%;border-radius:10px;border:1px solid #2b3642;background:rgba(8,12,16,.95);color:var(--text);
    padding:10px;font-family:Consolas,monospace;font-size:13px;}
  .field textarea{min-height:120px;resize:vertical;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .btn{border:1px solid #2b3642;background:rgba(18,22,27,.9);color:var(--text);border-radius:10px;padding:9px 12px;font-family:var(--royal);
    font-size:12px;cursor:pointer;user-select:none;}
  .btn:hover{border-color:#3a4a5a;}
  .btn.primary{border-color:rgba(31,143,58,.9);color:#bfe3c7;}
  .btn.danger{border-color:rgba(200,74,74,.9);color:#ffd0d0;}
  .btn.warn{border-color:rgba(209,169,58,.85);color:#ffe8b6;}
  .list{display:flex;flex-direction:column;gap:10px;max-height:280px;overflow:auto;padding-right:4px;}
  .item{border:1px solid #24303b;border-radius:12px;background:rgba(8,12,16,.85);padding:10px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
  .item .meta{display:flex;flex-direction:column;gap:4px;min-width:0;}
  .item .meta .t{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .pill{font-size:11px;font-weight:800;letter-spacing:.6px;border:1px solid #2b3642;border-radius:999px;padding:3px 8px;color:var(--blue);}
  .pill.core{color:#bfe3c7;border-color:rgba(31,143,58,.35);}
  .item .meta .label{font-size:12px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:440px;}
  .item .meta .id{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:440px;}
  .item .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
  .note{font-size:11px;color:var(--muted);line-height:1.4;}
  @media (max-width:980px){.sidebar{display:none;}.layout{padding-top:14px;}.search{width:52vw;min-width:180px;}}
  @media (max-width:560px){.brand{min-width:0;}.brand .subtitle{display:none;}.search{width:56vw;}body{font-size:14px;}}
</style>
</head>
<body>
<canvas id="noosphere" aria-hidden="true"></canvas>
<div class="vignette" aria-hidden="true"></div>

<button class="admin-pill" id="adminToggle" aria-label="Admin tools" title="Admin tools">
  <span class="dot" aria-hidden="true"></span>
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l9.06-9.06.92.92-9.06 9.06zM20.71 6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 0l-1.12 1.12 3.75 3.75 1.12-1.12z"/>
  </svg>
  ADMIN
</button>

<div class="modal" id="adminModal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="panel">
    <div class="panel-top">
      <div>
        <h3 id="adminTitle">VARUN ARCHIVE — ADMIN</h3>
        <div class="note">Everything you add/edit/delete is stored in your browser (localStorage). If you change PC/browser, export JSON first.</div>
      </div>
      <div class="tabs" role="tablist">
        <button class="tabbtn active" data-tab="chapters" type="button">Chapters</button>
        <button class="tabbtn" data-tab="revisions" type="button">Revisions</button>
        <button class="tabbtn" data-tab="backup" type="button">Backup</button>
        <button class="tabbtn" data-tab="close" type="button">Close ✕</button>
      </div>
    </div>

    <div id="tab-chapters">
      <div class="grid">
        <div class="section">
          <h4 id="chapterFormTitle">Add / Edit Chapter</h4>
          <div class="field"><label for="chapterTag">Chapter tag</label><input id="chapterTag" type="text" placeholder="e.g., -1 or NOW" /></div>
          <div class="field"><label for="chapterLabel">Chapter title (sidebar)</label><input id="chapterLabel" type="text" placeholder="Short label for the list" /></div>
          <div class="field"><label for="chapterBody">Chapter entry text</label><textarea id="chapterBody" placeholder="Write the entry text here..."></textarea></div>
          <div class="row">
            <button class="btn primary" type="button" id="saveChapterBtn">Save</button>
            <button class="btn" type="button" id="newChapterBtn">New</button>
            <button class="btn danger" type="button" id="deleteChapterBtn" disabled>Delete</button>
          </div>
          <div class="note" style="margin-top:8px;">Tip: click a chapter on the right list to edit it.</div>
        </div>
        <div class="section">
          <h4>All chapters</h4>
          <div class="list" id="chaptersAdminList"></div>
          <div class="note" style="margin-top:10px;">Reorder: drag & drop items in this list.</div>
        </div>
      </div>
    </div>

    <div id="tab-revisions" style="display:none;">
      <div class="grid">
        <div class="section">
          <h4 id="revFormTitle">Add / Edit Revision</h4>
          <div class="field"><label for="revDate">Revision date/time</label><input id="revDate" type="text" placeholder="e.g., M41.999 — 2026-02-15" /></div>
          <div class="field"><label for="revNote">Revision note</label><textarea id="revNote" placeholder="What changed?"></textarea></div>
          <div class="row">
            <button class="btn primary" type="button" id="saveRevBtn">Save</button>
            <button class="btn" type="button" id="newRevBtn">New</button>
            <button class="btn danger" type="button" id="deleteRevBtn" disabled>Delete</button>
          </div>
          <div class="note" style="margin-top:8px;">These appear inside a “Revision Log” chapter.</div>
        </div>
        <div class="section">
          <h4>Revision log entries</h4>
          <div class="list" id="revsAdminList"></div>
          <div class="note" style="margin-top:10px;">Reorder: drag & drop entries.</div>
        </div>
      </div>
    </div>

    <div id="tab-backup" style="display:none;">
      <div class="grid">
        <div class="section">
          <h4>Export</h4>
          <div class="note">Downloads your current chapters + revisions as a JSON file.</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" type="button" id="exportBtn">Export JSON</button>
            <button class="btn warn" type="button" id="resetBtn">Reset to Defaults</button>
          </div>
          <div class="note" style="margin-top:10px;">Reset only affects your browser’s saved data.</div>
        </div>
        <div class="section">
          <h4>Import</h4>
          <div class="note">Paste JSON you exported earlier.</div>
          <div class="field" style="margin-top:10px;">
            <label for="importArea">JSON</label>
            <textarea id="importArea" placeholder='{"chapters":[...],"revisions":[...]}'></textarea>
          </div>
          <div class="row"><button class="btn primary" type="button" id="importBtn">Import JSON</button></div>
          <div class="note" style="margin-top:10px;">If something breaks: refresh, then import again.</div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="backdrop" id="backdrop" aria-hidden="true"></div>

<aside class="drawer" id="drawer" aria-label="Chapters">
  <div class="drawer-top">
    <div class="dtitle">CHAPTERS</div>
    <button class="iconbtn" id="closeDrawer" aria-label="Close menu">✕</button>
  </div>
  <div class="chapters" id="chaptersDrawer"></div>
  <div class="meta">Access: Magenta-7+<br/>Archive Node: C-402-E / VARUN<br/>Integrity: Verified</div>
</aside>

<div class="app">
  <header class="topbar">
    <div class="topbar-inner">
      <button class="iconbtn" id="openDrawer" aria-label="Open menu">☰</button>
      <div class="brand">
        <div class="title">NOOSPHERE ARCHIVE</div>
        <div class="subtitle">Magos C-402 Epsilon Varun</div>
      </div>
      <div class="spacer"></div>
      <div class="search" role="search" aria-label="Search archive">
        <span class="hint">⌕</span>
        <input id="searchInput" type="search" placeholder="Search keywords (e.g., STC, injector, Last Rose)..." />
        <button class="clear" id="clearBtn" title="Clear">×</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar" aria-label="Chapters">
      <h3>CHAPTER LIST</h3>
      <div class="chapters" id="chaptersSidebar"></div>
      <div class="meta">Access: Magenta-7+<br/>Archive Node: C-402-E / VARUN<br/>Integrity: Verified</div>
    </aside>

    <main>
      <h1>NOOSPHERE ARCHIVE</h1>
      <h2>Magos C-402 Epsilon Varun</h2>
      <div id="contentRoot"></div>
      <footer>Data Integrity Verified.<br/>Access Level: Magenta-7 or Higher.<br/>Unauthorized replication punishable under Martian Code.</footer>
    </main>
  </div>
</div>

<script>
const STORAGE_KEY="varunArchive.v1";
const DEFAULT_CHAPTERS=[
  {id:"profile",tag:"CORE",label:"Profile Node",body:
`<p><strong>Designation:</strong> C-402 Epsilon Varun</p>
<p><strong>Rank:</strong> Magos Dominus (Exploratory Division)</p>
<p><strong>Affiliation:</strong> Adeptus Mechanicus</p>
<p><strong>Status:</strong> Active – Restricted Clearance Required</p>
<p><strong>Archive Span:</strong> 50 Years Prior to Current Imperial Date</p>`},
  {id:"y-50",tag:"-50",label:"Initial Deployment",body:
`<p class="year">-50 Years</p><p>Initial recorded field deployment under Forge oversight. Assigned to deep-void exploratory fleet operations. Specialization in archaeological recovery and adaptive battlefield augmentation.</p>`},
  {id:"y-44",tag:"-44",label:"STC Fragment",body:
`<p class="year">-44 Years</p><p>Recovered fragmented Standard Template Construct (STC) subroutine from derelict manufactorum structure. Data integrity at 23%. Deemed tactically viable.</p>`},
  {id:"y-38",tag:"-38",label:"Augmentation Delta-III",body:
`<p class="year">-38 Years</p><p>Augmentation Phase Delta-III completed. Integration of articulated mechadendrite cluster with injector, plasma micro-torch, and data-spike termination systems.</p>`},
  {id:"y-29",tag:"-29",label:"Classified Engagement",body:
`<p class="year">-29 Years</p><p>Participated in classified void engagement. Deployment of mobile battlefield autopsy protocols. Casualty reclamation efficiency exceeded projected thresholds.</p>`},
  {id:"y-21",tag:"-21",label:"Autonomy Grant",body:
`<p class="year">-21 Years</p><p>Reassignment to independent exploratory mandate. Increased operational autonomy granted.</p>`},
  {id:"y-14",tag:"-14",label:"Boards The Last Rose",body:
`<p class="year">-14 Years</p><p>Boarded void vessel <em>The Last Rose</em> under mutually beneficial technological accord. Integration into ship-based manufactorum oversight and expeditionary support.</p>`},
  {id:"y-7",tag:"-7",label:"Servo-skull Upgrade",body:
`<p class="year">-7 Years</p><p>Servo-skull reconnaissance unit upgraded. Dual ocular configuration implemented: one skeletal cavity retained for symbolic function; one active auspex scanner lens installed.</p>`},
  {id:"y-current",tag:"NOW",label:"Current Era",body:
`<p class="year">Current Era</p><p>Magos Varun continues exploratory operations and battlefield technological reclamation aboard <em>The Last Rose</em>. Multiple data clusters remain <span class="classified">CLASSIFIED</span>.</p>`}
];
const DEFAULT_REVISIONS=[{id:"rev-1",date:"M41.999 — Initial Archive Compilation",note:"First public Noosphere Archive rendering. Search + chapters index online."}];

function makeId(prefix="id"){return `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return {chapters:structuredClone(DEFAULT_CHAPTERS),revisions:structuredClone(DEFAULT_REVISIONS)};
    const parsed=JSON.parse(raw);
    if(!parsed||!Array.isArray(parsed.chapters)||!Array.isArray(parsed.revisions)) throw new Error("bad");
    return parsed;
  }catch(e){
    return {chapters:structuredClone(DEFAULT_CHAPTERS),revisions:structuredClone(DEFAULT_REVISIONS)};
  }
}
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
let state=loadState();

const contentRoot=document.getElementById("contentRoot");
const chaptersSidebar=document.getElementById("chaptersSidebar");
const chaptersDrawer=document.getElementById("chaptersDrawer");

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function makeBox(ch){
  const div=document.createElement("div");
  div.className="archive-box";
  div.id=ch.id;
  div.dataset.kind="chapter";
  div.dataset.chapterId=ch.id;
  div.innerHTML=ch.body||"";
  return div;
}

function renderRevisionBox(){
  const div=document.createElement("div");
  div.className="archive-box";
  div.id="revision-log";
  div.dataset.kind="revision-log";
  const header=`<p class="year">REV</p><p><strong>Revision Log</strong></p>`;
  const list=state.revisions.map(r=>`<p><span class="pill" style="margin-right:8px;">${escapeHtml(r.date||"")}</span> ${escapeHtml(r.note||"")}</p>`).join("");
  div.innerHTML=header+(list||`<p class="classified">No revisions recorded.</p>`);
  return div;
}

function renderContent(){
  contentRoot.innerHTML="";
  const profile=state.chapters.find(c=>c.id==="profile");
  if(profile) contentRoot.appendChild(makeBox(profile));

  const h2=document.createElement("h2");
  h2.textContent="Chronological Expedition Record";
  contentRoot.appendChild(h2);

  for(const ch of state.chapters){
    if(ch.id==="profile") continue;
    contentRoot.appendChild(makeBox(ch));
  }
  contentRoot.appendChild(renderRevisionBox());
  refreshBoxesCache();
}

function getSidebarChapters(){
  const out=[];
  const profile=state.chapters.find(c=>c.id==="profile");
  if(profile) out.push({id:profile.id,tag:profile.tag||"CORE",label:profile.label||"Profile"});
  out.push({id:"revision-log",tag:"REV",label:"Revision Log"});
  for(const ch of state.chapters){
    if(ch.id==="profile") continue;
    out.push({id:ch.id,tag:ch.tag||"—",label:ch.label||ch.id});
  }
  return out;
}

function renderSidebars(){
  const links=getSidebarChapters();
  const html=links.map(c=>`
    <a href="#${c.id}" data-target="${c.id}">
      <span class="tag">${escapeHtml(c.tag)}</span>
      <span class="label">${escapeHtml(c.label)}</span>
    </a>`).join("");
  chaptersSidebar.innerHTML=html;
  chaptersDrawer.innerHTML=html;
}

function smoothScrollTo(id){const el=document.getElementById(id); if(el) el.scrollIntoView({behavior:"smooth",block:"start"});}
document.addEventListener("click",(e)=>{
  const a=e.target.closest('a[data-target]'); if(!a) return;
  e.preventDefault(); smoothScrollTo(a.getAttribute("data-target")); closeDrawer();
});

/* Drawer */
const openBtn=document.getElementById("openDrawer");
const closeBtn=document.getElementById("closeDrawer");
const backdrop=document.getElementById("backdrop");
function openDrawer(){document.body.classList.add("drawer-open");}
function closeDrawer(){document.body.classList.remove("drawer-open");}
openBtn.addEventListener("click",openDrawer);
closeBtn.addEventListener("click",closeDrawer);
backdrop.addEventListener("click",closeDrawer);

/* Search (restore original each input) */
const input=document.getElementById("searchInput");
const clearBtn=document.getElementById("clearBtn");
let boxes=[];
function refreshBoxesCache(){
  boxes=Array.from(document.querySelectorAll(".archive-box"));
  boxes.forEach(b=>{b.dataset.original=b.innerHTML;});
}
function restoreOriginal(b){ if(b.dataset.original!=null) b.innerHTML=b.dataset.original; }
function escapeRegExp(s){return String(s).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");}
function highlightBox(box,q){
  const re=new RegExp(escapeRegExp(q),"ig");
  const walker=document.createTreeWalker(box,NodeFilter.SHOW_TEXT,null);
  const nodes=[];
  while(walker.nextNode()){
    const n=walker.currentNode;
    if(n.nodeValue && re.test(n.nodeValue)) nodes.push(n);
    re.lastIndex=0;
  }
  for(const n of nodes){
    const val=n.nodeValue; if(!val) continue;
    const frag=document.createDocumentFragment();
    let last=0;
    val.replace(re,(match,offset)=>{
      frag.appendChild(document.createTextNode(val.slice(last,offset)));
      const mk=document.createElement("mark"); mk.textContent=match; frag.appendChild(mk);
      last=offset+match.length; return match;
    });
    frag.appendChild(document.createTextNode(val.slice(last)));
    n.parentNode.replaceChild(frag,n);
  }
}
function applySearch(){
  const q=input.value.trim();
  if(!boxes.length) refreshBoxesCache();
  boxes.forEach(b=>{restoreOriginal(b); b.classList.remove("hidden");});
  if(!q) return;
  const ql=q.toLowerCase();
  boxes.forEach(b=>{
    const hit=b.innerText.toLowerCase().includes(ql);
    b.classList.toggle("hidden",!hit);
    if(hit) highlightBox(b,q);
  });
}
input.addEventListener("input",applySearch);
clearBtn.addEventListener("click",()=>{input.value="";applySearch();input.focus();});

/* Admin */
const adminToggle=document.getElementById("adminToggle");
const adminModal=document.getElementById("adminModal");
const tabBtns=Array.from(document.querySelectorAll(".tabbtn"));
const tabChapters=document.getElementById("tab-chapters");
const tabRevisions=document.getElementById("tab-revisions");
const tabBackup=document.getElementById("tab-backup");
function showTab(name){
  tabBtns.forEach(b=>b.classList.toggle("active",b.dataset.tab===name));
  tabChapters.style.display=(name==="chapters")?"":"none";
  tabRevisions.style.display=(name==="revisions")?"":"none";
  tabBackup.style.display=(name==="backup")?"":"none";
  if(name==="close") closeAdmin();
}
tabBtns.forEach(b=>b.addEventListener("click",()=>showTab(b.dataset.tab)));
function openAdmin(){document.body.classList.add("admin-on"); adminModal.classList.add("open"); showTab("chapters"); renderAdminLists(); resetChapterForm(); resetRevForm();}
function closeAdmin(){adminModal.classList.remove("open");}
adminToggle.addEventListener("click",()=>{adminModal.classList.contains("open")?closeAdmin():openAdmin();});
adminModal.addEventListener("click",(e)=>{if(e.target===adminModal) closeAdmin();});
window.addEventListener("keydown",(e)=>{if(e.key==="Escape"){closeDrawer(); if(adminModal.classList.contains("open")) closeAdmin();}});

/* Chapters CRUD */
const chaptersAdminList=document.getElementById("chaptersAdminList");
const chapterFormTitle=document.getElementById("chapterFormTitle");
const chapterTag=document.getElementById("chapterTag");
const chapterLabel=document.getElementById("chapterLabel");
const chapterBody=document.getElementById("chapterBody");
const saveChapterBtn=document.getElementById("saveChapterBtn");
const newChapterBtn=document.getElementById("newChapterBtn");
const deleteChapterBtn=document.getElementById("deleteChapterBtn");
let editingChapterId=null;

function slugify(text){return String(text).toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")||"chapter";}
function resetChapterForm(){
  editingChapterId=null; chapterFormTitle.textContent="Add / Edit Chapter";
  chapterTag.value=""; chapterLabel.value=""; chapterBody.value=""; deleteChapterBtn.disabled=true;
}
function htmlToPlain(html){
  const tmp=document.createElement("div"); tmp.innerHTML=html;
  tmp.querySelectorAll("p,div,br").forEach(el=>{ if(el.tagName.toLowerCase()==="br") return; el.insertAdjacentText("afterend","\n"); });
  return tmp.textContent.replace(/\n{3,}/g,"\n\n").trim();
}
function profileFromPlain(plain){
  const lines=String(plain).split("\n").map(s=>s.trim()).filter(Boolean);
  return lines.map(line=>{
    const idx=line.indexOf(":");
    if(idx>0 && idx<40){
      const k=line.slice(0,idx).trim(); const v=line.slice(idx+1).trim();
      return `<p><strong>${escapeHtml(k)}:</strong> ${escapeHtml(v)}</p>`;
    }
    return `<p>${escapeHtml(line)}</p>`;
  }).join("\n");
}
function plainToHtml(tag,label,plain){
  const lines=String(plain).split("\n").map(s=>s.trim()).filter(Boolean);
  const paras=lines.map(s=>`<p>${escapeHtml(s)}</p>`).join("");
  const t=tag.trim();
  const isNumeric=/^-?\d+$/.test(t);
  if(isNumeric) return `<p class="year">${escapeHtml(t)} Years</p>`+paras;
  if(t.toUpperCase()==="NOW") return `<p class="year">Current Era</p>`+paras;
  if(t.toUpperCase()==="CORE") return paras;
  return `<p class="year">${escapeHtml(t||"—")}</p><p><strong>${escapeHtml(label||"")}</strong></p>`+paras;
}
function loadChapterIntoForm(id){
  const ch=state.chapters.find(c=>c.id===id); if(!ch) return;
  editingChapterId=id; chapterFormTitle.textContent=`Editing: ${ch.label||ch.id}`;
  chapterTag.value=ch.tag||""; chapterLabel.value=ch.label||""; chapterBody.value=htmlToPlain(ch.body||"");
  deleteChapterBtn.disabled=false;
}
function saveChapter(){
  const tag=chapterTag.value.trim()||"NEW";
  const label=chapterLabel.value.trim()||"(untitled)";
  const bodyPlain=chapterBody.value.trim();
  if(!bodyPlain){chapterBody.focus(); return;}
  if(editingChapterId){
    const ch=state.chapters.find(c=>c.id===editingChapterId); if(!ch) return;
    ch.tag=tag; ch.label=label;
    ch.body=(editingChapterId==="profile") ? profileFromPlain(bodyPlain) : plainToHtml(tag,label,bodyPlain);
  } else {
    let idBase=slugify(label); let id=idBase;
    while(state.chapters.some(c=>c.id===id) || id==="revision-log"){ id=`${idBase}-${Math.random().toString(36).slice(2,6)}`; }
    state.chapters.push({id,tag,label,body:plainToHtml(tag,label,bodyPlain)});
    editingChapterId=id;
  }
  saveState(); renderAll(); renderAdminLists(); loadChapterIntoForm(editingChapterId);
}
function deleteChapter(){
  if(!editingChapterId) return;
  if(!confirm(`Delete chapter "${editingChapterId}"?`)) return;
  state.chapters=state.chapters.filter(c=>c.id!==editingChapterId);
  saveState(); resetChapterForm(); renderAll(); renderAdminLists();
}
saveChapterBtn.addEventListener("click",saveChapter);
newChapterBtn.addEventListener("click",resetChapterForm);
deleteChapterBtn.addEventListener("click",deleteChapter);

function renderChaptersAdminList(){
  chaptersAdminList.innerHTML=state.chapters.map(ch=>`
    <div class="item" draggable="true" data-id="${ch.id}">
      <div class="meta">
        <div class="t">
          <span class="pill ${ch.id==="profile"?"core":""}">${escapeHtml(ch.tag||"—")}</span>
          <div class="label">${escapeHtml(ch.label||ch.id)}</div>
        </div>
        <div class="id">${escapeHtml(ch.id)}</div>
      </div>
      <div class="actions">
        <button class="btn" type="button" data-act="edit" data-id="${ch.id}">Edit</button>
        <button class="btn danger" type="button" data-act="del" data-id="${ch.id}">Delete</button>
      </div>
    </div>`).join("");
}
chaptersAdminList.addEventListener("click",(e)=>{
  const btn=e.target.closest("button[data-act]"); if(!btn) return;
  const id=btn.dataset.id, act=btn.dataset.act;
  if(act==="edit"){loadChapterIntoForm(id); showTab("chapters");}
  if(act==="del"){editingChapterId=id; deleteChapter();}
});
let dragChapterId=null;
chaptersAdminList.addEventListener("dragstart",(e)=>{
  const item=e.target.closest(".item[data-id]"); if(!item) return;
  dragChapterId=item.dataset.id; e.dataTransfer.effectAllowed="move";
});
chaptersAdminList.addEventListener("dragover",(e)=>e.preventDefault());
chaptersAdminList.addEventListener("drop",(e)=>{
  e.preventDefault();
  const target=e.target.closest(".item[data-id]");
  if(!target || !dragChapterId) return;
  const targetId=target.dataset.id;
  if(targetId===dragChapterId) return;
  const from=state.chapters.findIndex(c=>c.id===dragChapterId);
  const to=state.chapters.findIndex(c=>c.id===targetId);
  if(from<0||to<0) return;
  const [moved]=state.chapters.splice(from,1);
  state.chapters.splice(to,0,moved);
  saveState(); renderAll(); renderAdminLists();
});

/* Revisions CRUD */
const revsAdminList=document.getElementById("revsAdminList");
const revDate=document.getElementById("revDate");
const revNote=document.getElementById("revNote");
const saveRevBtn=document.getElementById("saveRevBtn");
const newRevBtn=document.getElementById("newRevBtn");
const deleteRevBtn=document.getElementById("deleteRevBtn");
const revFormTitle=document.getElementById("revFormTitle");
let editingRevId=null;
function resetRevForm(){editingRevId=null; revFormTitle.textContent="Add / Edit Revision"; revDate.value=""; revNote.value=""; deleteRevBtn.disabled=true;}
function loadRevIntoForm(id){
  const r=state.revisions.find(x=>x.id===id); if(!r) return;
  editingRevId=id; revFormTitle.textContent=`Editing: ${r.date||r.id}`; revDate.value=r.date||""; revNote.value=r.note||""; deleteRevBtn.disabled=false;
}
function saveRevision(){
  const date=revDate.value.trim()||"Undated";
  const note=revNote.value.trim();
  if(!note){revNote.focus(); return;}
  if(editingRevId){
    const r=state.revisions.find(x=>x.id===editingRevId); if(!r) return;
    r.date=date; r.note=note;
  } else {
    const id=makeId("rev"); state.revisions.unshift({id,date,note}); editingRevId=id;
  }
  saveState(); renderAll(); renderAdminLists(); loadRevIntoForm(editingRevId);
}
function deleteRevision(){
  if(!editingRevId) return;
  if(!confirm("Delete this revision?")) return;
  state.revisions=state.revisions.filter(r=>r.id!==editingRevId);
  saveState(); resetRevForm(); renderAll(); renderAdminLists();
}
saveRevBtn.addEventListener("click",saveRevision);
newRevBtn.addEventListener("click",resetRevForm);
deleteRevBtn.addEventListener("click",deleteRevision);

function renderRevsAdminList(){
  revsAdminList.innerHTML=state.revisions.map(r=>`
    <div class="item" draggable="true" data-id="${r.id}">
      <div class="meta">
        <div class="t"><span class="pill">REV</span><div class="label">${escapeHtml(r.date||"Undated")}</div></div>
        <div class="id">${escapeHtml(r.note||"")}</div>
      </div>
      <div class="actions">
        <button class="btn" type="button" data-act="edit" data-id="${r.id}">Edit</button>
        <button class="btn danger" type="button" data-act="del" data-id="${r.id}">Delete</button>
      </div>
    </div>`).join("");
}
revsAdminList.addEventListener("click",(e)=>{
  const btn=e.target.closest("button[data-act]"); if(!btn) return;
  const id=btn.dataset.id, act=btn.dataset.act;
  if(act==="edit"){loadRevIntoForm(id); showTab("revisions");}
  if(act==="del"){editingRevId=id; deleteRevision();}
});
let dragRevId=null;
revsAdminList.addEventListener("dragstart",(e)=>{
  const item=e.target.closest(".item[data-id]"); if(!item) return;
  dragRevId=item.dataset.id; e.dataTransfer.effectAllowed="move";
});
revsAdminList.addEventListener("dragover",(e)=>e.preventDefault());
revsAdminList.addEventListener("drop",(e)=>{
  e.preventDefault();
  const target=e.target.closest(".item[data-id]");
  if(!target || !dragRevId) return;
  const targetId=target.dataset.id;
  if(targetId===dragRevId) return;
  const from=state.revisions.findIndex(r=>r.id===dragRevId);
  const to=state.revisions.findIndex(r=>r.id===targetId);
  if(from<0||to<0) return;
  const [moved]=state.revisions.splice(from,1);
  state.revisions.splice(to,0,moved);
  saveState(); renderAll(); renderAdminLists();
});

/* Backup */
const exportBtn=document.getElementById("exportBtn");
const resetBtn=document.getElementById("resetBtn");
const importBtn=document.getElementById("importBtn");
const importArea=document.getElementById("importArea");
exportBtn.addEventListener("click",()=>{
  const payload=JSON.stringify(state,null,2);
  const blob=new Blob([payload],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="varun-archive-backup.json";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
});
resetBtn.addEventListener("click",()=>{
  if(!confirm("Reset local data to defaults?")) return;
  state={chapters:structuredClone(DEFAULT_CHAPTERS),revisions:structuredClone(DEFAULT_REVISIONS)};
  saveState(); renderAll(); renderAdminLists(); resetChapterForm(); resetRevForm();
});
importBtn.addEventListener("click",()=>{
  try{
    const parsed=JSON.parse(importArea.value);
    if(!parsed||!Array.isArray(parsed.chapters)||!Array.isArray(parsed.revisions)){
      alert("JSON must be {chapters:[...], revisions:[...]}"); return;
    }
    state=parsed; saveState(); renderAll(); renderAdminLists(); resetChapterForm(); resetRevForm(); alert("Import complete.");
  }catch(e){alert("Invalid JSON.");}
});

function renderAdminLists(){renderChaptersAdminList(); renderRevsAdminList();}

/* Background */
(()=>{const canvas=document.getElementById("noosphere"); if(!canvas) return;
  const ctx=canvas.getContext("2d",{alpha:true});
  const prefersReduced=window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  const DPR=()=>Math.max(1,Math.min(2,window.devicePixelRatio||1));
  const bg={streaks:[],pulses:[],glyphs:[]};
  const rand=(a,b)=>Math.random()*(b-a)+a;
  function seed(n){
    bg.streaks=[];
    for(let i=0;i<n;i++){
      const diag=Math.random()<.42;
      bg.streaks.push({x:rand(-80,innerWidth+80),y:rand(0,innerHeight),len:rand(10,44),speed:rand(.10,.45),
        angle:diag?rand(-.28,-.06):rand(-.06,.06),alpha:rand(.05,.22),red:Math.random()<.045});
    }
    bg.pulses=[]; bg.glyphs=[];
  }
  function resize(){
    const dpr=DPR();
    canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr);
    canvas.style.width=innerWidth+"px"; canvas.style.height=innerHeight+"px";
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
    seed(prefersReduced?90:130);
    if(prefersReduced) drawStatic();
  }
  function spawnPulse(){
    if(bg.pulses.length>2) return;
    const vertical=Math.random()<.25;
    bg.pulses.push({t:0,vertical,pos:vertical?rand(.15,.85)*innerWidth:rand(.2,.8)*innerHeight,width:rand(140,320),alpha:rand(.06,.14)});
  }
  function spawnGlyphCluster(){
    if(bg.glyphs.length>6) return;
    const chars="01ABCDEF"; const count=Math.floor(rand(3,10));
    let text=""; for(let i=0;i<count;i++) text+=chars[Math.floor(rand(0,chars.length))];
    bg.glyphs.push({x:rand(18,innerWidth-60),y:rand(26,innerHeight-18),text,life:Math.floor(rand(70,150)),alpha:rand(.06,.18),red:Math.random()<.08});
  }
  function clearFrame(){
    ctx.clearRect(0,0,innerWidth,innerHeight);
    ctx.fillStyle="rgba(10,14,18,0.10)"; ctx.fillRect(0,0,innerWidth,innerHeight);
  }
  function drawStreaks(){
    for(const s of bg.streaks){
      ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.angle);
      ctx.strokeStyle=s.red?"rgba(180,40,40,0.22)":"rgba(125,190,255,0.24)";
      ctx.globalAlpha=s.alpha; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(s.len,0); ctx.stroke(); ctx.restore();
      s.x+=Math.cos(s.angle)*s.speed*1.4; s.y+=Math.sin(s.angle)*s.speed*0.6+s.speed*0.06;
      if(s.x>innerWidth+120||s.y>innerHeight+80){
        s.x=rand(-140,-20); s.y=rand(0,innerHeight); s.len=rand(10,44); s.speed=rand(.10,.45); s.alpha=rand(.05,.22); s.red=Math.random()<.045;
      }
    }
  }
  function drawPulses(){
    bg.pulses=bg.pulses.filter(p=>p.t<1);
    for(const p of bg.pulses){
      p.t+=0.010;
      ctx.save(); ctx.globalAlpha=p.alpha*(1-p.t); ctx.strokeStyle="rgba(125,190,255,0.22)"; ctx.lineWidth=2; ctx.beginPath();
      if(p.vertical){const x=p.pos+Math.sin(p.t*Math.PI)*p.width*0.08; ctx.moveTo(x,0); ctx.lineTo(x,innerHeight);}
      else {const y=p.pos+Math.cos(p.t*Math.PI)*p.width*0.07; ctx.moveTo(0,y); ctx.lineTo(innerWidth,y);}
      ctx.stroke(); ctx.restore();
    }
  }
  function drawGlyphs(){
    ctx.save(); ctx.font="10px Consolas, monospace";
    bg.glyphs=bg.glyphs.filter(g=>g.life>0);
    for(const g of bg.glyphs){
      ctx.fillStyle=g.red?"rgba(200,60,60,0.28)":"rgba(145,200,255,0.30)";
      ctx.globalAlpha=g.alpha*(g.life/150); ctx.fillText(g.text,g.x,g.y); g.life-=1;
    }
    ctx.restore();
  }
  function drawStatic(){
    clearFrame(); drawStreaks(); for(let i=0;i<4;i++) spawnGlyphCluster(); drawGlyphs();
    ctx.save(); ctx.globalAlpha=0.10; ctx.strokeStyle="rgba(125,190,255,0.20)"; ctx.lineWidth=1;
    for(let i=0;i<5;i++){const y=rand(0,innerHeight); ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(innerWidth,y); ctx.stroke();}
    ctx.restore();
  }
  function animate(){
    if(prefersReduced) return;
    clearFrame(); if(Math.random()<0.020) spawnPulse(); if(Math.random()<0.045) spawnGlyphCluster();
    drawStreaks(); drawPulses(); drawGlyphs(); requestAnimationFrame(animate);
  }
  addEventListener("resize",resize); resize(); if(!prefersReduced) animate();
})();

/* Boot */
function renderAll(){renderContent(); renderSidebars(); refreshBoxesCache(); applySearch();}
renderAll();
</script>
</body>
</html>
